<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Julius Projects</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/svg+xml" href="icon.svg">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta name="theme-color" content="#0a0a0a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap');

    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0a0a0a;
      --bg2: #111111;
      --bg3: #1a1a1a;
      --border: #2a2a2a;
      --text: #e0e0e0;
      --text-dim: #666;
      --red: #ff1744;
      --red-glow: 0 0 20px rgba(255, 23, 68, 0.4), 0 0 40px rgba(255, 23, 68, 0.2);
      --red-glow-strong: 0 0 20px rgba(255, 23, 68, 0.6), 0 0 60px rgba(255, 23, 68, 0.3), 0 0 100px rgba(255, 23, 68, 0.1);
      --neon-red: #ff4466;
      --neon-border: rgba(255, 23, 68, 0.3);
    }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Login Screen */
    #login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: var(--bg);
    }

    .login-box {
      text-align: center;
      padding: 3rem;
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 380px;
      max-width: 90vw;
    }

    .login-box .logo-container {
      margin-bottom: 2rem;
    }

    .login-box h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--red);
      text-shadow: var(--red-glow);
    }

    .login-box p {
      color: var(--text-dim);
      font-size: 0.85rem;
      margin-bottom: 2rem;
    }

    .login-box input {
      width: 100%;
      padding: 12px 16px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      outline: none;
      transition: border-color 0.3s;
      margin-bottom: 1rem;
    }

    .login-box input:focus {
      border-color: var(--red);
      box-shadow: 0 0 10px rgba(255, 23, 68, 0.2);
    }

    .login-box .error {
      color: var(--red);
      font-size: 0.8rem;
      margin-bottom: 1rem;
      display: none;
    }

    /* App */
    #app {
      display: none;
      max-width: 1000px;
      margin: 0 auto;
      padding: 1.5rem;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .header h1 {
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--text);
    }

    .header h1 span {
      color: var(--red);
      text-shadow: var(--red-glow);
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .btn {
      padding: 8px 16px;
      border: 1px solid var(--border);
      background: var(--bg2);
      color: var(--text);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-family: 'Inter', sans-serif;
      transition: all 0.2s;
    }

    .btn:hover {
      border-color: var(--neon-border);
      background: var(--bg3);
    }

    .btn-red {
      background: var(--red);
      border-color: var(--red);
      color: white;
      font-weight: 500;
    }

    .btn-red:hover {
      box-shadow: var(--red-glow);
    }

    .btn-sm {
      padding: 5px 10px;
      font-size: 0.78rem;
    }

    .btn-danger {
      color: var(--red);
      border-color: rgba(255, 23, 68, 0.3);
    }

    .btn-danger:hover {
      background: rgba(255, 23, 68, 0.1);
      border-color: var(--red);
    }

    /* Timer Section */
    .timer-section {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .timer-display {
      font-family: 'JetBrains Mono', monospace;
      font-size: 3rem;
      font-weight: 600;
      text-align: center;
      color: var(--text);
      margin: 1rem 0;
      letter-spacing: 2px;
    }

    .timer-display.running {
      color: var(--red);
      text-shadow: var(--red-glow-strong);
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    .timer-controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .timer-project-select {
      padding: 8px 14px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.9rem;
      font-family: 'Inter', sans-serif;
      outline: none;
      cursor: pointer;
    }

    .timer-project-select:focus {
      border-color: var(--red);
    }

    .timer-btn {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid var(--red);
      background: transparent;
      color: var(--red);
      font-size: 1.2rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .timer-btn:hover {
      background: var(--red);
      color: white;
      box-shadow: var(--red-glow);
    }

    .timer-btn.active {
      background: var(--red);
      color: white;
      box-shadow: var(--red-glow);
    }

    /* Manual Entry */
    .manual-entry {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      justify-content: center;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .manual-entry input, .manual-entry select {
      padding: 8px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.85rem;
      font-family: 'Inter', sans-serif;
      outline: none;
    }

    .manual-entry input:focus, .manual-entry select:focus {
      border-color: var(--red);
    }

    .manual-entry input[type="number"] {
      width: 70px;
      text-align: center;
    }

    .manual-entry input[type="date"] {
      width: 140px;
    }

    /* Stats Cards */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .stat-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.2rem;
    }

    .stat-card .label {
      font-size: 0.75rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 0.5rem;
    }

    .stat-card .value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.8rem;
      font-weight: 600;
      color: var(--text);
    }

    .stat-card .value span {
      font-size: 0.9rem;
      color: var(--text-dim);
      font-weight: 400;
    }

    .stat-card .sub {
      font-size: 0.8rem;
      color: var(--text-dim);
      margin-top: 0.3rem;
    }

    .stat-card.goal-met .value {
      color: #00e676;
      text-shadow: 0 0 20px rgba(0, 230, 118, 0.4);
    }

    /* Progress Bar */
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--bg);
      border-radius: 3px;
      margin-top: 0.8rem;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--red);
      border-radius: 3px;
      transition: width 0.5s ease;
      box-shadow: 0 0 10px rgba(255, 23, 68, 0.4);
    }

    .progress-fill.complete {
      background: #00e676;
      box-shadow: 0 0 10px rgba(0, 230, 118, 0.4);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 0;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      padding: 10px 20px;
      cursor: pointer;
      font-size: 0.85rem;
      color: var(--text-dim);
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
      font-family: 'Inter', sans-serif;
    }

    .tab:hover { color: var(--text); }

    .tab.active {
      color: var(--red);
      border-bottom-color: var(--red);
    }

    /* Table */
    .entries-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1.5rem;
    }

    .entries-table th {
      font-size: 0.75rem;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .entries-table td {
      padding: 10px 12px;
      font-size: 0.85rem;
      border-bottom: 1px solid var(--border);
    }

    .entries-table tr:hover td {
      background: var(--bg3);
    }

    .project-tag {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      background: rgba(255, 23, 68, 0.1);
      color: var(--neon-red);
      border: 1px solid rgba(255, 23, 68, 0.2);
    }

    .hours-val {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
    }

    /* Project Bars */
    .project-breakdown {
      margin-bottom: 1.5rem;
    }

    .project-bar-row {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 0.8rem;
    }

    .project-bar-label {
      width: 120px;
      font-size: 0.85rem;
      flex-shrink: 0;
    }

    .project-bar-track {
      flex: 1;
      height: 24px;
      background: var(--bg);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }

    .project-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
      min-width: 2px;
    }

    .project-bar-hours {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85rem;
      width: 60px;
      text-align: right;
      flex-shrink: 0;
    }

    /* Settings */
    .settings-section {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .settings-section h3 {
      font-size: 0.9rem;
      margin-bottom: 1rem;
      color: var(--text);
    }

    .setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.8rem 0;
      border-bottom: 1px solid var(--border);
    }

    .setting-row:last-child { border-bottom: none; }

    .setting-row label {
      font-size: 0.85rem;
      color: var(--text-dim);
    }

    .setting-row input {
      padding: 6px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.85rem;
      font-family: 'Inter', sans-serif;
      width: 80px;
      text-align: center;
      outline: none;
    }

    .setting-row input:focus {
      border-color: var(--red);
    }

    /* Project list in settings */
    .project-list-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.6rem 0;
      border-bottom: 1px solid var(--border);
    }

    .project-list-item:last-child { border-bottom: none; }

    .add-project-row {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }

    .add-project-row input {
      flex: 1;
      padding: 8px 12px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.85rem;
      font-family: 'Inter', sans-serif;
      outline: none;
    }

    .add-project-row input:focus {
      border-color: var(--red);
    }

    /* Week nav */
    .week-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .week-nav span {
      font-size: 0.9rem;
      font-weight: 500;
      min-width: 200px;
      text-align: center;
    }

    /* Logo SVG */
    .logo-svg {
      width: 48px;
      height: 48px;
    }

    .logo-svg.large {
      width: 72px;
      height: 72px;
    }

    /* Neon line decoration */
    .neon-line {
      width: 60px;
      height: 2px;
      background: var(--red);
      box-shadow: var(--red-glow);
      margin: 0.5rem auto 1.5rem;
      border-radius: 1px;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .timer-display { font-size: 2.2rem; }
      .manual-entry { flex-wrap: wrap; justify-content: center; }
      .stats-row { grid-template-columns: 1fr 1fr; }
      .header { flex-direction: column; gap: 1rem; align-items: flex-start; }
      .week-nav span { font-size: 0.8rem; min-width: 160px; }
    }

    /* Delete entry btn */
    .delete-entry {
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 0.8rem;
      padding: 2px 6px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .delete-entry:hover {
      color: var(--red);
      background: rgba(255, 23, 68, 0.1);
    }
  </style>
</head>
<body>

<!-- Login -->
<div id="login-screen">
  <div class="login-box">
    <div class="logo-container">
      <svg class="logo-svg large" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <filter id="glow-login">
            <feGaussianBlur stdDeviation="3" result="blur"/>
            <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>
        <rect width="100" height="100" rx="20" fill="#111"/>
        <rect x="2" y="2" width="96" height="96" rx="18" fill="none" stroke="#ff1744" stroke-width="1.5" opacity="0.4" filter="url(#glow-login)"/>
        <text x="50" y="42" text-anchor="middle" font-family="JetBrains Mono, monospace" font-size="28" font-weight="700" fill="#ff1744" filter="url(#glow-login)">JP</text>
        <line x1="25" y1="52" x2="75" y2="52" stroke="#ff1744" stroke-width="1.5" opacity="0.6" filter="url(#glow-login)"/>
        <text x="50" y="72" text-anchor="middle" font-family="Inter, sans-serif" font-size="10" font-weight="400" fill="#666" letter-spacing="3">PROJECTS</text>
      </svg>
    </div>
    <h1>Julius Projects</h1>
    <div class="neon-line"></div>
    <p>Zeiterfassung &amp; Projektmanagement</p>
    <input type="password" id="password-input" placeholder="Passwort eingeben" autofocus>
    <div class="error" id="login-error">Falsches Passwort</div>
    <button class="btn btn-red" style="width:100%" onclick="tryLogin()">Einloggen</button>
  </div>
</div>

<!-- App -->
<div id="app">
  <div class="header">
    <div class="header-left">
      <svg class="logo-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <filter id="glow-header">
            <feGaussianBlur stdDeviation="2" result="blur"/>
            <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
          </filter>
        </defs>
        <rect width="100" height="100" rx="20" fill="#111"/>
        <rect x="2" y="2" width="96" height="96" rx="18" fill="none" stroke="#ff1744" stroke-width="1.5" opacity="0.4" filter="url(#glow-header)"/>
        <text x="50" y="42" text-anchor="middle" font-family="JetBrains Mono, monospace" font-size="28" font-weight="700" fill="#ff1744" filter="url(#glow-header)">JP</text>
        <line x1="25" y1="52" x2="75" y2="52" stroke="#ff1744" stroke-width="1.5" opacity="0.6" filter="url(#glow-header)"/>
        <text x="50" y="72" text-anchor="middle" font-family="Inter, sans-serif" font-size="10" font-weight="400" fill="#666" letter-spacing="3">PROJECTS</text>
      </svg>
      <h1>Julius <span>Projects</span></h1>
    </div>
    <div class="header-right">
      <button class="btn btn-sm" onclick="showTab('settings')">⚙ Settings</button>
      <button class="btn btn-sm btn-danger" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Timer -->
  <div class="timer-section">
    <div class="timer-controls">
      <div id="timer-projects-list" style="display:flex;flex-direction:column;gap:0.5rem;align-items:center">
        <div class="timer-project-row" style="display:flex;align-items:center;gap:0.5rem">
          <select class="timer-project-select" data-timer-project></select>
        </div>
      </div>
      <button class="btn btn-sm" onclick="addTimerProject()" title="Projekt hinzufügen" style="font-size:1.1rem;padding:5px 10px;margin-left:0.5rem">+</button>
      <button class="timer-btn" id="timer-toggle" onclick="toggleTimer()">▶</button>
    </div>
    <div class="timer-display" id="timer-display">00:00:00</div>
    <div class="manual-entry">
      <select id="manual-project" style="padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.85rem;font-family:'Inter',sans-serif;outline:none"></select>
      <input type="number" id="manual-hours" placeholder="Std" min="0" max="24" step="0.25">
      <input type="date" id="manual-date">
      <button class="btn btn-sm btn-red" onclick="addManualEntry()">+ Eintragen</button>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-row" id="stats-row"></div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" onclick="showTab('week')">Woche</button>
    <button class="tab" onclick="showTab('month')">Monat</button>
    <button class="tab" onclick="showTab('entries')">Einträge</button>
    <button class="tab" onclick="showTab('settings')">Einstellungen</button>
  </div>

  <!-- Week View -->
  <div id="view-week">
    <div class="week-nav">
      <button class="btn btn-sm" onclick="changeWeek(-1)">← Vorher</button>
      <span id="week-label"></span>
      <button class="btn btn-sm" onclick="changeWeek(1)">Weiter →</button>
    </div>
    <div class="project-breakdown" id="week-breakdown"></div>
  </div>

  <!-- Month View -->
  <div id="view-month" style="display:none">
    <div class="week-nav">
      <button class="btn btn-sm" onclick="changeMonth(-1)">← Vorher</button>
      <span id="month-label"></span>
      <button class="btn btn-sm" onclick="changeMonth(1)">Weiter →</button>
    </div>
    <div class="project-breakdown" id="month-breakdown"></div>
  </div>

  <!-- Entries -->
  <div id="view-entries" style="display:none">
    <table class="entries-table">
      <thead>
        <tr><th>Datum</th><th>Projekt</th><th>Stunden</th><th></th></tr>
      </thead>
      <tbody id="entries-body"></tbody>
    </table>
  </div>

  <!-- Settings -->
  <div id="view-settings" style="display:none">
    <div class="settings-section">
      <h3>Wochenziel</h3>
      <div class="setting-row">
        <label>Stunden pro Woche</label>
        <input type="number" id="goal-input" min="1" max="80" step="1" onchange="saveGoal()">
      </div>
    </div>
    <div class="settings-section">
      <h3>Passwort ändern</h3>
      <div class="setting-row">
        <label>Neues Passwort</label>
        <input type="password" id="new-password" style="width:160px">
      </div>
      <div style="text-align:right;margin-top:0.5rem">
        <button class="btn btn-sm btn-red" onclick="changePassword()">Speichern</button>
      </div>
    </div>
    <div class="settings-section">
      <h3>Projekte</h3>
      <div id="project-list"></div>
      <div class="add-project-row">
        <input type="text" id="new-project-name" placeholder="Neues Projekt...">
        <button class="btn btn-sm btn-red" onclick="addProject()">Hinzufügen</button>
      </div>
    </div>
    <div class="settings-section">
      <h3>Daten</h3>
      <div style="display:flex;gap:0.5rem">
        <button class="btn btn-sm" onclick="exportData()">Export JSON</button>
        <button class="btn btn-sm" onclick="document.getElementById('import-file').click()">Import JSON</button>
        <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(event)">
      </div>
    </div>
  </div>
</div>

<script>
  // ---- DATA ----
  const DEFAULT_PROJECTS = ['PropGate', 'TrainQ', 'Sonstiges', 'OpenClaw'];
  const DEFAULT_GOAL = 25;
  const DEFAULT_PASSWORD = 'julius2024';
  const PROJECT_COLORS = ['#ff1744','#ff5252','#ff867f','#e53935','#c62828','#ff6e40','#ff3d00','#dd2c00'];

  function getData() {
    const d = localStorage.getItem('jp_data');
    if (d) return JSON.parse(d);
    return {
      projects: [...DEFAULT_PROJECTS],
      entries: [],
      weeklyGoal: DEFAULT_GOAL,
      password: DEFAULT_PASSWORD
    };
  }

  function saveData(data) {
    localStorage.setItem('jp_data', JSON.stringify(data));
  }

  let data = getData();
  let timerRunning = false;
  let timerStart = null;
  let timerInterval = null;
  let currentWeekOffset = 0;
  let currentMonthOffset = 0;

  // ---- AUTH ----
  function tryLogin() {
    const pw = document.getElementById('password-input').value;
    if (pw === data.password) {
      sessionStorage.setItem('jp_auth', '1');
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      init();
    } else {
      document.getElementById('login-error').style.display = 'block';
      document.getElementById('password-input').value = '';
    }
  }

  document.getElementById('password-input').addEventListener('keydown', e => {
    if (e.key === 'Enter') tryLogin();
  });

  function logout() {
    sessionStorage.removeItem('jp_auth');
    location.reload();
  }

  function changePassword() {
    const np = document.getElementById('new-password').value.trim();
    if (np.length < 3) return alert('Mindestens 3 Zeichen');
    data.password = np;
    saveData(data);
    document.getElementById('new-password').value = '';
    alert('Passwort geändert');
  }

  // ---- INIT ----
  function init() {
    populateProjectSelects();
    document.getElementById('manual-date').value = todayStr();
    document.getElementById('goal-input').value = data.weeklyGoal;
    renderAll();

    // Restore running timer
    const saved = localStorage.getItem('jp_timer');
    if (saved) {
      const t = JSON.parse(saved);
      timerStart = t.start;
      // Restore project selects
      const projects = t.projects || [t.project];
      const firstSel = document.querySelector('[data-timer-project]');
      if (firstSel && projects[0]) firstSel.value = projects[0];
      for (let i = 1; i < projects.length; i++) {
        addTimerProject();
        const sels = document.querySelectorAll('[data-timer-project]');
        sels[sels.length - 1].value = projects[i];
      }
      startTimerUI();
    }
  }

  function todayStr() {
    return new Date().toISOString().slice(0, 10);
  }

  // ---- PROJECTS ----
  function populateProjectSelects() {
    const opts = data.projects.map(p => `<option value="${p}">${p}</option>`).join('');
    document.querySelectorAll('[data-timer-project]').forEach(s => {
      const cur = s.value;
      s.innerHTML = opts;
      if (cur) s.value = cur;
    });
    document.getElementById('manual-project').innerHTML = opts;
  }

  function addTimerProject() {
    const list = document.getElementById('timer-projects-list');
    const row = document.createElement('div');
    row.className = 'timer-project-row';
    row.style.cssText = 'display:flex;align-items:center;gap:0.5rem';
    const sel = document.createElement('select');
    sel.className = 'timer-project-select';
    sel.setAttribute('data-timer-project', '');
    sel.innerHTML = data.projects.map(p => `<option value="${p}">${p}</option>`).join('');
    const rmBtn = document.createElement('button');
    rmBtn.className = 'btn btn-sm btn-danger';
    rmBtn.textContent = '✕';
    rmBtn.style.cssText = 'padding:4px 8px;font-size:0.8rem';
    rmBtn.onclick = () => row.remove();
    row.appendChild(sel);
    row.appendChild(rmBtn);
    list.appendChild(row);
  }

  function getSelectedTimerProjects() {
    return [...document.querySelectorAll('[data-timer-project]')].map(s => s.value);
  }

  function addProject() {
    const name = document.getElementById('new-project-name').value.trim();
    if (!name || data.projects.includes(name)) return;
    data.projects.push(name);
    saveData(data);
    document.getElementById('new-project-name').value = '';
    populateProjectSelects();
    renderAll();
  }

  function removeProject(name) {
    if (!confirm(`"${name}" wirklich löschen? Einträge bleiben erhalten.`)) return;
    data.projects = data.projects.filter(p => p !== name);
    saveData(data);
    populateProjectSelects();
    renderAll();
  }

  // ---- TIMER ----
  function toggleTimer() {
    if (timerRunning) stopTimer();
    else startTimer();
  }

  function startTimer() {
    timerStart = Date.now();
    localStorage.setItem('jp_timer', JSON.stringify({
      start: timerStart,
      projects: getSelectedTimerProjects()
    }));
    startTimerUI();
  }

  function startTimerUI() {
    timerRunning = true;
    document.getElementById('timer-toggle').innerHTML = '⏹';
    document.getElementById('timer-toggle').classList.add('active');
    document.getElementById('timer-display').classList.add('running');
    timerInterval = setInterval(updateTimerDisplay, 1000);
    updateTimerDisplay();
  }

  function updateTimerDisplay() {
    const elapsed = Math.floor((Date.now() - timerStart) / 1000);
    const h = String(Math.floor(elapsed / 3600)).padStart(2, '0');
    const m = String(Math.floor((elapsed % 3600) / 60)).padStart(2, '0');
    const s = String(elapsed % 60).padStart(2, '0');
    document.getElementById('timer-display').textContent = `${h}:${m}:${s}`;
  }

  function stopTimer() {
    const elapsed = (Date.now() - timerStart) / 3600000;
    const totalHours = Math.round(elapsed * 4) / 4; // Round to 0.25
    const saved = localStorage.getItem('jp_timer') ? JSON.parse(localStorage.getItem('jp_timer')) : null;
    const projects = saved && saved.projects ? saved.projects : getSelectedTimerProjects();
    // Deduplicate
    const unique = [...new Set(projects)];
    const perProject = Math.round((totalHours / unique.length) * 4) / 4;

    if (totalHours >= 0.05 && unique.length > 0) {
      unique.forEach((project, i) => {
        data.entries.push({
          id: Date.now() + i,
          date: todayStr(),
          project,
          hours: Math.max(0.25, perProject)
        });
      });
      saveData(data);
    }

    clearInterval(timerInterval);
    timerRunning = false;
    timerStart = null;
    localStorage.removeItem('jp_timer');
    document.getElementById('timer-toggle').innerHTML = '▶';
    document.getElementById('timer-toggle').classList.remove('active');
    document.getElementById('timer-display').classList.remove('running');
    document.getElementById('timer-display').textContent = '00:00:00';
    renderAll();
  }

  // ---- MANUAL ENTRY ----
  function addManualEntry() {
    const project = document.getElementById('manual-project').value;
    const hours = parseFloat(document.getElementById('manual-hours').value);
    const date = document.getElementById('manual-date').value;
    if (!project || !hours || !date || hours <= 0) return;
    data.entries.push({ id: Date.now(), date, project, hours });
    saveData(data);
    document.getElementById('manual-hours').value = '';
    renderAll();
  }

  function deleteEntry(id) {
    data.entries = data.entries.filter(e => e.id !== id);
    saveData(data);
    renderAll();
  }

  // ---- WEEK HELPERS ----
  function getWeekStart(offset) {
    const d = new Date();
    d.setDate(d.getDate() - d.getDay() + 1 + offset * 7);
    d.setHours(0, 0, 0, 0);
    return d;
  }

  function getWeekEnd(offset) {
    const d = getWeekStart(offset);
    d.setDate(d.getDate() + 6);
    return d;
  }

  function formatDate(d) {
    return d.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
  }

  function getWeekEntries(offset) {
    const start = getWeekStart(offset);
    const end = getWeekEnd(offset);
    return data.entries.filter(e => {
      const d = new Date(e.date);
      return d >= start && d <= end;
    });
  }

  // ---- MONTH HELPERS ----
  function getMonthRange(offset) {
    const d = new Date();
    d.setMonth(d.getMonth() + offset, 1);
    const start = new Date(d.getFullYear(), d.getMonth(), 1);
    const end = new Date(d.getFullYear(), d.getMonth() + 1, 0);
    return { start, end, label: d.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' }) };
  }

  function getMonthEntries(offset) {
    const { start, end } = getMonthRange(offset);
    return data.entries.filter(e => {
      const d = new Date(e.date);
      return d >= start && d <= end;
    });
  }

  // ---- RENDERING ----
  function renderAll() {
    renderStats();
    renderWeek();
    renderMonth();
    renderEntries();
    renderProjectSettings();
  }

  function renderStats() {
    const weekEntries = getWeekEntries(currentWeekOffset);
    const weekTotal = weekEntries.reduce((s, e) => s + e.hours, 0);
    const pct = Math.min(100, (weekTotal / data.weeklyGoal) * 100);
    const goalMet = weekTotal >= data.weeklyGoal;

    const todayEntries = data.entries.filter(e => e.date === todayStr());
    const todayTotal = todayEntries.reduce((s, e) => s + e.hours, 0);

    const allTotal = data.entries.reduce((s, e) => s + e.hours, 0);

    document.getElementById('stats-row').innerHTML = `
      <div class="stat-card ${goalMet ? 'goal-met' : ''}">
        <div class="label">Diese Woche</div>
        <div class="value">${weekTotal.toFixed(1)} <span>/ ${data.weeklyGoal}h</span></div>
        <div class="progress-bar"><div class="progress-fill ${goalMet ? 'complete' : ''}" style="width:${pct}%"></div></div>
      </div>
      <div class="stat-card">
        <div class="label">Heute</div>
        <div class="value">${todayTotal.toFixed(1)} <span>h</span></div>
        <div class="sub">${todayEntries.length} Einträge</div>
      </div>
      <div class="stat-card">
        <div class="label">Gesamt</div>
        <div class="value">${allTotal.toFixed(1)} <span>h</span></div>
        <div class="sub">${data.entries.length} Einträge</div>
      </div>
    `;
  }

  function renderBreakdown(entries, containerId, maxHours) {
    const byProject = {};
    entries.forEach(e => {
      byProject[e.project] = (byProject[e.project] || 0) + e.hours;
    });
    const total = entries.reduce((s, e) => s + e.hours, 0);
    const max = maxHours || Math.max(total, 1);

    let html = '';
    data.projects.forEach((p, i) => {
      const h = byProject[p] || 0;
      const pct = (h / max) * 100;
      const color = PROJECT_COLORS[i % PROJECT_COLORS.length];
      html += `
        <div class="project-bar-row">
          <div class="project-bar-label">${p}</div>
          <div class="project-bar-track">
            <div class="project-bar-fill" style="width:${pct}%;background:${color};box-shadow:0 0 10px ${color}44"></div>
          </div>
          <div class="project-bar-hours">${h.toFixed(1)}h</div>
        </div>
      `;
    });

    // Entries for deleted projects
    Object.keys(byProject).forEach(p => {
      if (!data.projects.includes(p)) {
        const h = byProject[p];
        html += `
          <div class="project-bar-row">
            <div class="project-bar-label" style="color:var(--text-dim)">${p}</div>
            <div class="project-bar-track">
              <div class="project-bar-fill" style="width:${(h/max)*100}%;background:#666"></div>
            </div>
            <div class="project-bar-hours">${h.toFixed(1)}h</div>
          </div>
        `;
      }
    });

    html += `<div style="text-align:right;margin-top:0.5rem;font-family:'JetBrains Mono',monospace;font-size:0.9rem;color:var(--text-dim)">Gesamt: ${total.toFixed(1)}h</div>`;
    document.getElementById(containerId).innerHTML = html;
  }

  function renderWeek() {
    const ws = getWeekStart(currentWeekOffset);
    const we = getWeekEnd(currentWeekOffset);
    document.getElementById('week-label').textContent = `${formatDate(ws)} – ${formatDate(we)}`;
    renderBreakdown(getWeekEntries(currentWeekOffset), 'week-breakdown', data.weeklyGoal);
  }

  function renderMonth() {
    const { label } = getMonthRange(currentMonthOffset);
    document.getElementById('month-label').textContent = label;
    renderBreakdown(getMonthEntries(currentMonthOffset), 'month-breakdown');
  }

  function renderEntries() {
    const sorted = [...data.entries].sort((a, b) => b.date.localeCompare(a.date) || b.id - a.id);
    const html = sorted.slice(0, 100).map(e => `
      <tr>
        <td>${new Date(e.date).toLocaleDateString('de-DE')}</td>
        <td><span class="project-tag">${e.project}</span></td>
        <td class="hours-val">${e.hours.toFixed(2)}h</td>
        <td><button class="delete-entry" onclick="deleteEntry(${e.id})">✕</button></td>
      </tr>
    `).join('');
    document.getElementById('entries-body').innerHTML = html || '<tr><td colspan="4" style="text-align:center;color:var(--text-dim)">Keine Einträge</td></tr>';
  }

  function renderProjectSettings() {
    document.getElementById('project-list').innerHTML = data.projects.map(p => `
      <div class="project-list-item">
        <span>${p}</span>
        <button class="btn btn-sm btn-danger" onclick="removeProject('${p}')">Entfernen</button>
      </div>
    `).join('');
  }

  // ---- TABS ----
  function showTab(name) {
    ['week', 'month', 'entries', 'settings'].forEach(t => {
      document.getElementById('view-' + t).style.display = t === name ? 'block' : 'none';
    });
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    const labels = { week: 'Woche', month: 'Monat', entries: 'Einträge', settings: 'Einstellungen' };
    document.querySelectorAll('.tab').forEach(t => {
      if (t.textContent === labels[name]) t.classList.add('active');
    });
  }

  // ---- NAV ----
  function changeWeek(d) { currentWeekOffset += d; renderWeek(); }
  function changeMonth(d) { currentMonthOffset += d; renderMonth(); }

  function saveGoal() {
    data.weeklyGoal = parseInt(document.getElementById('goal-input').value) || DEFAULT_GOAL;
    saveData(data);
    renderAll();
  }

  // ---- EXPORT/IMPORT ----
  function exportData() {
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'julius-projects-backup.json';
    a.click();
  }

  function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const imported = JSON.parse(e.target.result);
        if (imported.projects && imported.entries) {
          data = imported;
          saveData(data);
          renderAll();
          populateProjectSelects();
          alert('Import erfolgreich');
        }
      } catch { alert('Fehler beim Import'); }
    };
    reader.readAsText(file);
    event.target.value = '';
  }

  // ---- BOOT ----
  if (sessionStorage.getItem('jp_auth') === '1') {
    document.getElementById('login-screen').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    init();
  }
</script>
</body>
</html>
